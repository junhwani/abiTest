<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
  </head>
  <body>
    <ul>
      <li>컨트랙트주소 : <span id="contractAddr"></span> </li>
      <li>내 어카운트 주소 : <span id="accountAddr"></span> </li>
      <li>내 어카운트 잔액 : <span id="accountBalance"></span> </li>
      <li>토큰 주소 : <span id="tokenAddress"></span> </li>
      <li>토큰 잔액 : <span id="tokenBalance"></span> </li>
    </ul>

  </body>
  <script type="text/javascript" src="jquery.js"></script>
  <script type="text/javascript" src="https://cdn.rawgit.com/ethereum/web3.js/develop/dist/web3.js"></script>
  <script type="text/javascript">
    var contractAddress = "0xFb9DB2380b974AbF1f884A5d510Fd5793292cE3f";
    var abi =
    {
      "contractName": "Crowdsale",
      "abi": [
        {
          "constant": true,
          "inputs": [],
          "name": "transferableToken",
          "outputs": [
            {
              "name": "",
              "type": "uint256"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "deadline",
          "outputs": [
            {
              "name": "",
              "type": "uint256"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "fundingEth",
          "outputs": [
            {
              "name": "",
              "type": "uint256"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "fundingEthReached",
          "outputs": [
            {
              "name": "",
              "type": "bool"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "soldToken",
          "outputs": [
            {
              "name": "",
              "type": "uint256"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "isOpened",
          "outputs": [
            {
              "name": "",
              "type": "bool"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "tokenReward",
          "outputs": [
            {
              "name": "",
              "type": "address"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "startTime",
          "outputs": [
            {
              "name": "",
              "type": "uint256"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "owner",
          "outputs": [
            {
              "name": "",
              "type": "address"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "TokenPerEther",
          "outputs": [
            {
              "name": "",
              "type": "uint256"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "price",
          "outputs": [
            {
              "name": "",
              "type": "uint256"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": false,
          "inputs": [
            {
              "name": "_new",
              "type": "address"
            }
          ],
          "name": "transferOwnership",
          "outputs": [],
          "payable": false,
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "name": "_addressOfTokenUsedAsReward",
              "type": "address"
            }
          ],
          "payable": false,
          "stateMutability": "nonpayable",
          "type": "constructor"
        },
        {
          "payable": true,
          "stateMutability": "payable",
          "type": "fallback"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": false,
              "name": "fundingEth",
              "type": "uint256"
            },
            {
              "indexed": false,
              "name": "deadline",
              "type": "uint256"
            },
            {
              "indexed": false,
              "name": "transferableToken",
              "type": "uint256"
            },
            {
              "indexed": false,
              "name": "beneficiary",
              "type": "address"
            }
          ],
          "name": "CrowdsaleStart",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": false,
              "name": "beneficiary",
              "type": "address"
            },
            {
              "indexed": false,
              "name": "fundingEth",
              "type": "uint256"
            },
            {
              "indexed": false,
              "name": "amountRaised",
              "type": "uint256"
            },
            {
              "indexed": false,
              "name": "reached",
              "type": "bool"
            },
            {
              "indexed": false,
              "name": "raisedToken",
              "type": "uint256"
            }
          ],
          "name": "CheckGoalReached",
          "type": "event"
        },
        {
          "anonymous": false,
          "inputs": [
            {
              "indexed": false,
              "name": "oldaddr",
              "type": "address"
            },
            {
              "indexed": false,
              "name": "newaddr",
              "type": "address"
            }
          ],
          "name": "TransferOwnership",
          "type": "event"
        },
        {
          "constant": false,
          "inputs": [
            {
              "name": "_afterDay",
              "type": "uint256"
            }
          ],
          "name": "startCrowSale",
          "outputs": [],
          "payable": false,
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "BonusRate",
          "outputs": [
            {
              "name": "",
              "type": "uint256"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "getEthBalance",
          "outputs": [
            {
              "name": "",
              "type": "uint256"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": false,
          "inputs": [],
          "name": "destroy",
          "outputs": [],
          "payable": false,
          "stateMutability": "nonpayable",
          "type": "function"
        }
      ]};

var declaration;
var myAddr;
var startingBlock;
var explorer = "https://ropsten.etherscan.io";





window.addEventListener('load', function(){
  if(typeof web3 !== 'undefined'){
    window.web3 = new Web3(web3.currentProvider);
  } else{
    console.log('No web3? You should consider trying MetaMask!');
    window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
  }

  startApp();
});

function startApp(){
  declaration = web3.eth.contract(abi).at(contractAddress);
  document.getElementById('contractAddr').innerHTML = getLink(contractAddress);

  web3.eth.getAccounts(function(e, r){
    if(!e){
      myAddr = r[0];
      document.getElementById('accountAddr').innerHTML = getLink(myAddr);
      web3.eth.getBalance(myAddr, function(e,r){
        document.getElementById('accountBalance').innerHTML = Number(web3.fromWei(Number(r), 'ether')).toFixed(2)+" ETH";
      });
    } else{
      console.log(err);
    }
  });

  var tokenAddr = '0xb785f1612a0b59d3192453e37c9f639a8ef679a6';
  document.getElementById('tokenAddress').innerHTML = getLink(tokenAddr);

  web3.eth.getBalance(tokenAddr, function(e, r){
    document.getElementById('tokenBalance').innerHTML = r;
  });

  /*
    Solidity 함수 가져오는 방법
  */
  declaration.getEth.call(function(e,r){
    console.log(Number(web3.fromWei(Number(r), 'ether')));
  });

  declaration.isOpened.call(function(e,r){
    console.log(r);
  });
}

function getLink(addr) {
  if (addr.length == 42) {
    return '<a target="_blank" href="' + explorer + '/address/' + addr + '">' + addr +'</a>';
  } else {
    return '<a target="_blank" href="' + explorer + '/tx/' + addr + '">' + addr +'</a>';
  }
}

function showObj(obj){
  var str = "";
  for(key in obj){
    str += key+"="+obj[key]+"\n";
  }

  return str;
}

  </script>
</html>
